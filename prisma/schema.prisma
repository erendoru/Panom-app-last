generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}


enum PanelType {
  BILLBOARD
  BILLBOARD_PLUS
  GIANTBOARD
  MEGALIGHT
  CLP
  MEGABOARD
  KULEBOARD
  ALINLIK
  LIGHTBOX
  MAXIBOARD
  YOL_PANOSU
}

enum TrafficLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          String
  name          String
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  screenOwnerProfile ScreenOwner?
  advertiserProfile  Advertiser?
  transactions       Transaction[]
}

model ScreenOwner {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  companyName  String
  taxId        String?
  address      String?
  approved     Boolean  @default(false)
  
  screens      Screen[]
  payouts      Payout[]
  balance      OwnerBalance?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Advertiser {
  id           String   @id @default(uuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  companyName  String?
  billingInfo  String?    // Address, Tax info etc.
  
  campaigns    Campaign[]
  staticRentals StaticRental[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Screen {
  id               String            @id @default(uuid())
  ownerId          String
  owner            ScreenOwner       @relation(fields: [ownerId], references: [id])
  name             String
  city             String
  district         String
  address          String
  latitude         Float
  longitude        Float
  resolutionWidth  Int
  resolutionHeight Int
  orientation      String
  loopDurationSec  Int               @default(60)
  slotDurationSec  Int               @default(10)
  maxPlaysPerHour  Int               // Calculated capacity
  basePricePerPlay Decimal
  currency         String            @default("TRY")
  active           Boolean           @default(false) // Admin must approve or Owner can toggle
  previewImageUrl  String?

  campaignScreens  CampaignScreen[]
  scheduledPlays   ScheduledPlay[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Template {
  id               String   @id @default(uuid())
  name             String
  category         String
  screenRatio      String   // e.g. "16:9", "9:16"
  configString       String     // Structure for the builder
  previewUrl       String?
  active           Boolean  @default(true)
  createdAt        DateTime @default(now())
}

model Campaign {
  id              String         @id @default(uuid())
  advertiserId    String
  advertiser      Advertiser     @relation(fields: [advertiserId], references: [id])
  name            String
  brandName       String
  status          String @default("DRAFT")
  startDate       DateTime
  endDate         DateTime
  daysOfWeek      String         // e.g. "1,2,3,4,5,6,7" or bitmask
  timeWindows     String           // Array of {start: "08:00", end: "12:00"}
  totalBudget     Decimal
  currency        String         @default("TRY")
  
  creatives       Creative[]
  campaignScreens CampaignScreen[]
  scheduledPlays  ScheduledPlay[]
  transactions    Transaction[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model CampaignScreen {
  id             String   @id @default(uuid())
  campaignId     String
  campaign       Campaign @relation(fields: [campaignId], references: [id])
  screenId       String
  screen         Screen   @relation(fields: [screenId], references: [id])
  allocatedPlays Int
  pricePerPlay   Decimal // Snapshot of price at booking time

  @@unique([campaignId, screenId])
}

model Creative {
  id              String       @id @default(uuid())
  campaignId      String
  campaign        Campaign     @relation(fields: [campaignId], references: [id])
  type            String
  fileUrl         String
  width           Int
  height          Int
  status          String       @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?

  createdAt       DateTime     @default(now())
}

model ScheduledPlay {
  id         String   @id @default(uuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  screenId   String
  screen     Screen   @relation(fields: [screenId], references: [id])
  playTime   DateTime
  status     String   @default("SCHEDULED") // SCHEDULED, PLAYED, FAILED

  createdAt  DateTime @default(now())
  
  @@index([screenId, playTime])
}

model Transaction {
  id                String            @id @default(uuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])
  campaignId        String?
  campaign          Campaign?         @relation(fields: [campaignId], references: [id])
  amount            Decimal
  currency          String            @default("TRY")
  status            String
  provider          String            // e.g. "STRIPE", "IYZICO", "MOCK"
  providerPaymentId String?
  
  createdAt         DateTime          @default(now())
}

model OwnerBalance {
  id             String      @id @default(uuid())
  screenOwnerId  String      @unique
  screenOwner    ScreenOwner @relation(fields: [screenOwnerId], references: [id])
  amount         Decimal     @default(0)
  updatedAt      DateTime    @updatedAt
}

model Payout {
  id            String      @id @default(uuid())
  screenOwnerId String
  screenOwner   ScreenOwner @relation(fields: [screenOwnerId], references: [id])
  amount        Decimal
  status        String      // REQUESTED, PAID
  createdAt     DateTime    @default(now())
}

// Enhanced Static Billboards with 11 Types
enum LocationType {
  AVM
  HIGHWAY
  MAIN_ROAD
  CITY_CENTER
  SQUARE
  STREET
  OPEN_AREA
  OTHER
}

enum SocialGrade {
  A_PLUS
  A
  B
  C
  D
}

model StaticPanel {
  id                         String         @id @default(uuid())
  name                       String
  type                       PanelType
  subType                    String?
  city                       String
  district                   String
  address                    String
  latitude                   Float
  longitude                  Float
  width                      Float
  height                     Float
  priceWeekly                Float
  priceDaily                 Float?
  minRentalDays              Int            @default(7)  // Minimum rental period in days
  
  // Location & Analytics
  locationType               LocationType   @default(OPEN_AREA)
  socialGrade                SocialGrade    @default(B)
  
  isAVM                      Boolean        @default(false)
  avmName                    String?
  active                     Boolean        @default(true)
  imageUrl                   String?
  estimatedDailyImpressions  Int            @default(0)
  trafficLevel               TrafficLevel   @default(MEDIUM)
  blockedDates               Json?          // Array of {startDate, endDate} objects
  
  // Pano Sahibi Bilgileri (Admin görür)
  ownerName                  String?
  ownerPhone                 String?
  
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  rentals                    StaticRental[]
  cartItems                  CartItem[]
  orderItems                 OrderItem[]

  @@map("static_panels")
}

model StaticRental {
  id            String      @id @default(uuid())
  advertiserId  String
  advertiser    Advertiser  @relation(fields: [advertiserId], references: [id])
  panelId       String
  panel         StaticPanel @relation(fields: [panelId], references: [id])
  startDate     DateTime
  endDate       DateTime
  totalPrice    Decimal
  currency      String      @default("TRY")
  status        String      @default("PENDING_PAYMENT") // PENDING_PAYMENT, ACTIVE, COMPLETED, CANCELLED
  creativeUrl   String?
  designRequested Boolean @default(false)
  
  // Analytics fields
  totalDays           Int      @default(0)
  estimatedImpressions Int     @default(0)
  actualImpressions   Int?     // Optional actual data
  impressionsByDate   Json?    // {"2024-01-01": 1500, "2024-01-02": 1600}
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

// Blog Posts
model BlogPost {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  content     String   @db.Text
  excerpt     String?
  imageUrl    String?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Site Updates / Changelog
model Update {
  id          String   @id @default(uuid())
  title       String
  content     String   @db.Text
  category    String   // "Kampanya Başlatma", "Erişilebilirlik", "Raporlama ve Analiz", "Genel"
  imageUrl    String?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Fiyatlandırma Kuralları (Toplu İndirimler)
model PricingRule {
  id              String   @id @default(uuid())
  name            String   // "Kentvizyon CLP 20+ İndirimi"
  
  // Filtreler (hangi panolara uygulanır)
  panelType       PanelType?  // null = tüm türler
  ownerName       String?     // null = tüm sahipler
  city            String?     // null = tüm şehirler
  
  // Kural
  minQuantity     Int         // Minimum adet
  
  // İndirim (biri doldurulur)
  discountPercent Float?      // %25 gibi
  fixedUnitPrice  Float?      // 1500 TL gibi (birim başı sabit fiyat)
  
  priority        Int         @default(0)  // Yüksek = öncelikli
  active          Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("pricing_rules")
}

// Sepet Öğeleri
model CartItem {
  id          String      @id @default(uuid())
  
  // Sahiplik
  userId      String?     // Giriş yapmış kullanıcı
  sessionId   String      // Misafir için localStorage session ID
  
  // İçerik
  panelId     String
  panel       StaticPanel @relation(fields: [panelId], references: [id])
  startDate   DateTime?   // Sepet sayfasında seçilecek
  endDate     DateTime?
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@map("cart_items")
}

// Sipariş Durumları
enum OrderStatus {
  PENDING      // Beklemede
  REVIEWING    // İnceleniyor
  APPROVED     // Onaylandı
  IN_PROGRESS  // Üretimde
  COMPLETED    // Tamamlandı
  CANCELLED    // İptal
}

// Siparişler
model Order {
  id              String       @id @default(uuid())
  orderNumber     String       @unique  // ORD-2024-001
  status          OrderStatus  @default(PENDING)
  
  // Kampanya
  campaignName    String
  startDate       DateTime
  endDate         DateTime
  
  // İletişim
  contactName     String
  contactPhone    String
  contactEmail    String
  companyName     String?
  notes           String?      @db.Text
  
  // Görseller
  hasOwnCreatives Boolean      @default(false)
  needsDesignHelp Boolean      @default(false)
  
  // İlişkiler
  userId          String?
  items           OrderItem[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("orders")
}

// Sipariş Kalemleri
model OrderItem {
  id          String      @id @default(uuid())
  orderId     String
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  panelId     String
  panel       StaticPanel @relation(fields: [panelId], references: [id])
  
  startDate   DateTime
  endDate     DateTime
  weeklyPrice Float
  
  // Görsel
  creativeUrl String?     // Yüklenen görsel
  
  createdAt   DateTime    @default(now())

  @@map("order_items")
}
